<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="utf-8">
  <title>Позвонить голосовому боту</title>
  <script src="https://cdn.voximplant.com/voximplant.min.js"></script>
</head>
<body>
  <button id="call" disabled>Инициализация...</button>
  <div id="status" style="margin-top: 10px; color: #666;"></div>

<script>
// Ждем загрузки документа
window.addEventListener('DOMContentLoaded', async () => {
  // Проверяем, что VoxImplant загружен
  if (typeof VoxImplant === 'undefined') {
    console.error('VoxImplant SDK не загружен!');
    document.getElementById('status').textContent = 'Ошибка: SDK не загружен';
    return;
  }
  
  console.log('VoxImplant SDK версия:', VoxImplant.version || 'неизвестна');
  
  const vox = VoxImplant.getInstance();
  const callButton = document.getElementById('call');
  const statusDiv = document.getElementById('status');
  let currentCall = null;
  
  function updateStatus(text) {
    console.log(text);
    statusDiv.textContent = text;
  }
  
  // Проверяем доступные методы
  console.log('Доступные методы vox:', Object.getOwnPropertyNames(Object.getPrototypeOf(vox)));
  
  // Определяем метод подписки на события
  const addEvent = (target, eventName, handler) => {
    if (typeof target.on === 'function') {
      target.on(eventName, handler);
    } else if (typeof target.addEventListener === 'function') {
      target.addEventListener(eventName, handler);
    } else {
      console.error('Не найден метод подписки на события для', target);
    }
  };
  
  // Настройка обработчиков событий ДО инициализации
  addEvent(vox, VoxImplant.Events.SDKReady, () => {
    updateStatus('SDK готов к работе');
  });
  
  // Переменные для отслеживания попыток логина
  let loginVariants = [
    '0809@gircychatnj.n9.voximplant.com',                    // основной юзер
    'testtttt:0809@gircychatnj.n9.voximplant.com',          // субюзер с двоеточием
    'testtttt@gircychatnj.n9.voximplant.com',               // субюзер напрямую
    '0809.testtttt@gircychatnj.n9.voximplant.com',          // через точку
    'testtttt@0809@gircychatnj.n9.voximplant.com',          // двойной @
  ];
  let currentLoginIndex = 0;
  let isAuthInProgress = false;
  
  addEvent(vox, VoxImplant.Events.ConnectionEstablished, () => {
    updateStatus('Соединение установлено, выполняется авторизация...');
    
    // Функция для попытки логина
    function tryLogin() {
      if (currentLoginIndex < loginVariants.length && !isAuthInProgress) {
        isAuthInProgress = true;
        const loginName = loginVariants[currentLoginIndex];
        console.log(`Пробуем логин ${currentLoginIndex + 1}/${loginVariants.length}:`, loginName);
        updateStatus(`Пробуем логин ${currentLoginIndex + 1}/${loginVariants.length}: ${loginName}`);
        currentLoginIndex++;
        
        try {
          vox.login(loginName, 'Uzolon.8585');
        } catch (err) {
          console.error('Ошибка при вызове login:', err);
          isAuthInProgress = false;
          setTimeout(tryLogin, 500);
        }
      } else if (currentLoginIndex >= loginVariants.length) {
        updateStatus('Все варианты логина исчерпаны. Проверьте настройки пользователя в VoxImplant.');
      }
    }
    
    // Начинаем с первого варианта
    tryLogin();
  });
  
  addEvent(vox, VoxImplant.Events.ConnectionFailed, (e) => {
    updateStatus('Ошибка соединения: ' + e.message);
    console.error('Ошибка соединения:', e);
  });
  
  addEvent(vox, VoxImplant.Events.ConnectionClosed, () => {
    updateStatus('Соединение закрыто');
    callButton.disabled = true;
    callButton.textContent = 'Соединение закрыто';
  });
  
  addEvent(vox, VoxImplant.Events.AuthResult, (e) => {
    isAuthInProgress = false;
    
    if (e.result) {
      updateStatus('Авторизация успешна! Готов к звонкам.');
      callButton.textContent = 'Позвонить';
      callButton.disabled = false;
      
      // Настройка обработчика звонка
      callButton.onclick = () => {
        if (currentCall) {
          // Завершить текущий звонок
          currentCall.hangup();
          currentCall = null;
          callButton.textContent = 'Позвонить';
          updateStatus('Звонок завершен');
        } else {
          // Начать новый звонок
          updateStatus('Звоню...');
          currentCall = vox.call({video: false});
          
          addEvent(currentCall, VoxImplant.CallEvents.Connected, () => {
            updateStatus('Звонок подключен');
            callButton.textContent = 'Завершить звонок';
          });
          
          addEvent(currentCall, VoxImplant.CallEvents.Disconnected, () => {
            updateStatus('Звонок завершен');
            callButton.textContent = 'Позвонить';
            currentCall = null;
          });
          
          addEvent(currentCall, VoxImplant.CallEvents.Failed, (e) => {
            updateStatus('Ошибка звонка: ' + e.reason);
            callButton.textContent = 'Позвонить';
            currentCall = null;
          });
        }
      };
    } else {
      console.error('AuthResult отрицательный:', e);
      
      // Коды ошибок:
      // 401 - неверный пароль
      // 404 - пользователь не найден
      // 500 - внутренняя ошибка сервера
      // 701 - токен истек
      let errorMessage = '';
      if (e.code === 404) {
        errorMessage = 'Пользователь не найден';
      } else if (e.code === 401) {
        errorMessage = 'Неверный пароль';
      } else if (e.code === 500) {
        errorMessage = 'Ошибка сервера VoxImplant';
      } else {
        errorMessage = `Ошибка ${e.code}`;
      }
      
      console.log(`Попытка ${currentLoginIndex}/${loginVariants.length} неудачна: ${errorMessage}`);
      
      // Пробуем следующий вариант
      if (currentLoginIndex < loginVariants.length) {
        setTimeout(() => {
          const tryLogin = () => {
            if (currentLoginIndex < loginVariants.length && !isAuthInProgress) {
              isAuthInProgress = true;
              const loginName = loginVariants[currentLoginIndex];
              console.log(`Пробуем логин ${currentLoginIndex + 1}/${loginVariants.length}:`, loginName);
              updateStatus(`Пробуем логин ${currentLoginIndex + 1}/${loginVariants.length}: ${loginName}`);
              currentLoginIndex++;
              
              try {
                vox.login(loginName, 'Uzolon.8585');
              } catch (err) {
                console.error('Ошибка при вызове login:', err);
                isAuthInProgress = false;
                setTimeout(tryLogin, 500);
              }
            } else if (currentLoginIndex >= loginVariants.length) {
              updateStatus('Все варианты логина исчерпаны. Проверьте настройки пользователя в VoxImplant.');
            }
          };
          tryLogin();
        }, 1000);
      } else {
        updateStatus('Все варианты логина исчерпаны. Проверьте настройки пользователя в VoxImplant.');
      }
    }
  });
  
  try {
    // 1. Инициализация SDK
    updateStatus('Инициализация SDK...');
    await vox.init({micRequired: true});
    
    // 2. Подключение к серверу (БЕЗ await для логина)
    updateStatus('Подключение к VoxImplant...');
    await vox.connect();
    // Логин будет выполнен в обработчике ConnectionEstablished
    
  } catch (error) {
    updateStatus('Критическая ошибка: ' + error.message);
    console.error('Ошибка инициализации:', error);
  }
});
</script>
</body>
</html>
