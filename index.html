<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="utf-8">
  <title>Позвонить голосовому боту</title>
  <script src="https://cdn.voximplant.com/voximplant.min.js"></script>
</head>
<body>
  <button id="call" disabled>Инициализация...</button>
  <div id="status" style="margin-top: 10px; color: #666;"></div>

<script>
// Ждем загрузки документа
window.addEventListener('DOMContentLoaded', async () => {
  // Проверяем, что VoxImplant загружен
  if (typeof VoxImplant === 'undefined') {
    console.error('VoxImplant SDK не загружен!');
    document.getElementById('status').textContent = 'Ошибка: SDK не загружен';
    return;
  }
  
  console.log('VoxImplant SDK версия:', VoxImplant.version || 'неизвестна');
  
  const vox = VoxImplant.getInstance();
  const callButton = document.getElementById('call');
  const statusDiv = document.getElementById('status');
  let currentCall = null;
  
  function updateStatus(text) {
    console.log(text);
    statusDiv.textContent = text;
  }
  
  // Проверяем доступные методы
  console.log('Доступные методы vox:', Object.getOwnPropertyNames(Object.getPrototypeOf(vox)));
  
  // Определяем метод подписки на события
  const addEvent = (target, eventName, handler) => {
    if (typeof target.on === 'function') {
      target.on(eventName, handler);
    } else if (typeof target.addEventListener === 'function') {
      target.addEventListener(eventName, handler);
    } else {
      console.error('Не найден метод подписки на события для', target);
    }
  };
  
  // Настройка обработчиков событий ДО инициализации
  addEvent(vox, VoxImplant.Events.SDKReady, () => {
    updateStatus('SDK готов к работе');
  });
  
  addEvent(vox, VoxImplant.Events.ConnectionEstablished, async () => {
    updateStatus('Соединение установлено, выполняется авторизация...');
    
    // Попробуем разные варианты логина
    const loginVariants = [
      'testtttt@webrtc.gircychatnj.n9.voximplant.com',  // субюзер@приложение
      'webrtc.gircychatnj.n9.voximplant.com',           // просто приложение
      '0809@webrtc.gircychatnj.n9.voximplant.com',      // основной юзер@приложение
      'testtttt@0809@webrtc.gircychatnj.n9.voximplant.com' // субюзер@юзер@приложение
    ];
    
    for (const loginName of loginVariants) {
      try {
        console.log('Пробуем логин:', loginName);
        await vox.login(loginName, 'Uzolon.8585');
        updateStatus('Авторизация успешна с: ' + loginName);
        console.log('Успешная авторизация с:', loginName);
        break;
      } catch (err) {
        console.error('Ошибка с логином', loginName, ':', err);
        updateStatus('Ошибка с ' + loginName + ': ' + err.message);
      }
    }
  });
  
  addEvent(vox, VoxImplant.Events.ConnectionFailed, (e) => {
    updateStatus('Ошибка соединения: ' + e.message);
    console.error('Ошибка соединения:', e);
  });
  
  addEvent(vox, VoxImplant.Events.ConnectionClosed, () => {
    updateStatus('Соединение закрыто');
    callButton.disabled = true;
    callButton.textContent = 'Соединение закрыто';
  });
  
  addEvent(vox, VoxImplant.Events.AuthResult, (e) => {
    if (e.result) {
      updateStatus('Авторизация успешна! Готов к звонкам.');
      callButton.textContent = 'Позвонить';
      callButton.disabled = false;
      
      // Настройка обработчика звонка
      callButton.onclick = () => {
        if (currentCall) {
          // Завершить текущий звонок
          currentCall.hangup();
          currentCall = null;
          callButton.textContent = 'Позвонить';
          updateStatus('Звонок завершен');
        } else {
          // Начать новый звонок
          updateStatus('Звоню...');
          currentCall = vox.call({video: false});
          
          addEvent(currentCall, VoxImplant.CallEvents.Connected, () => {
            updateStatus('Звонок подключен');
            callButton.textContent = 'Завершить звонок';
          });
          
          addEvent(currentCall, VoxImplant.CallEvents.Disconnected, () => {
            updateStatus('Звонок завершен');
            callButton.textContent = 'Позвонить';
            currentCall = null;
          });
          
          addEvent(currentCall, VoxImplant.CallEvents.Failed, (e) => {
            updateStatus('Ошибка звонка: ' + e.reason);
            callButton.textContent = 'Позвонить';
            currentCall = null;
          });
        }
      };
    } else {
      updateStatus('Ошибка авторизации: код ' + e.code);
      console.error('AuthResult отрицательный:', e);
    }
  });
  
  try {
    // 1. Инициализация SDK
    updateStatus('Инициализация SDK...');
    await vox.init({micRequired: true});
    
    // 2. Подключение к серверу (БЕЗ await для логина)
    updateStatus('Подключение к VoxImplant...');
    await vox.connect();
    // Логин будет выполнен в обработчике ConnectionEstablished
    
  } catch (error) {
    updateStatus('Критическая ошибка: ' + error.message);
    console.error('Ошибка инициализации:', error);
  }
});
</script>
</body>
</html>
